stages:
  - build
  - test
  - link

cache: 
  paths:
    - vendor
    - node_modules
    - .env
  key: $CI_COMMIT_REF_SLUG

building:
  stage: build
  tags: 
    - museums
  script:
    - composer install
    - cp .env.example .env
    - php artisan key:generate
    - php artisan migrate:fresh --seed
  rules:
    - if: $CI_COMMIT_BRANCH == 'production'
testing:
  stage: test
  tags:
    - museums
  script:
    - php ./vendor/bin/phpunit

linking:
  stage: link
  allow_failure: true
  tags:
    - museums
  script:
    - New-Item -Path C:\nginx\project\ -ItemType SymbolicLink -Value .
  rules:
    - if: $CI_COMMIT_BRANCH == 'production'

storage_link:
  stage: link
  allow_failure: true
  tags:
    - museums
  script: 
    - cd C:\nginx\project
    - New-Item -Path C:\nginx\project\public\storage\ -ItemType SymbolicLink -Value .\storage\app\public
  rules:
    - if: $CI_COMMIT_BRANCH == 'production'